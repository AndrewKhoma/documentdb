SET search_path TO helio_api,helio_core,helio_api_catalog;
SET helio_api.next_collection_id TO 2500;
SET helio_api.next_collection_index_id TO 2500;

-- Utility function to add multiple documents to a collection.
CREATE OR REPLACE FUNCTION insert_docs(p_db TEXT, p_coll TEXT, p_num INT, p_start INT default 0)
RETURNS void
AS $$
DECLARE
    num INTEGER := p_start;
    docText bson;
BEGIN
    WHILE num < p_num + p_start LOOP
        docText :=  CONCAT('{ "a" : ', num, '}');
        PERFORM helio_api.insert_one(p_db, p_coll, docText::helio_api_catalog.bson, NULL);
        num := num + 1;
    END LOOP;
END;
$$
LANGUAGE plpgsql;
SELECT helio_api.drop_collection('db', 'collstats1');
 drop_collection 
-----------------
 f
(1 row)

-- Non existing collection should return zero values
SELECT helio_api.coll_stats('db', 'collstats1');
                                                                                                                                                                       coll_stats                                                                                                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "0"}, "storageSize" : { "$numberLong" : "0"}, "totalSize" : { "$numberLong" : "0"}, "nindexes" : { "$numberInt" : "0" }, "totalIndexSize" : { "$numberLong" : "0"}, "indexSizes" : {  }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api.coll_stats('db', 'collstats1', 1024);
                                                                                                                                                                         coll_stats                                                                                                                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "0"}, "storageSize" : { "$numberLong" : "0"}, "totalSize" : { "$numberLong" : "0"}, "nindexes" : { "$numberInt" : "0" }, "totalIndexSize" : { "$numberLong" : "0"}, "indexSizes" : {  }, "scaleFactor" : { "$numberLong" : "1024"}, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Create Collection
SELECT helio_api.create_collection('db', 'collstats1');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

-- coll_stats on empty collection
SELECT helio_api.coll_stats('db', 'collstats1');
                                                                                                                                                                                                                              coll_stats                                                                                                                                                                                                                              
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "0"}, "avgObjSize" : { "$numberInt" : "0" }, "storageSize" : { "$numberLong" : "65536"}, "nindexes" : { "$numberInt" : "1" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "65536"}, "totalSize" : { "$numberLong" : "131072"}, "indexSizes" : { "_id_" : { "$numberLong" : "65536"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api.coll_stats('db', 'collstats1', 1024);
                                                                                                                                                                                                                         coll_stats                                                                                                                                                                                                                          
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "0"}, "avgObjSize" : { "$numberInt" : "0" }, "storageSize" : { "$numberLong" : "64"}, "nindexes" : { "$numberInt" : "1" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "64"}, "totalSize" : { "$numberLong" : "128"}, "indexSizes" : { "_id_" : { "$numberLong" : "64"} }, "scaleFactor" : { "$numberLong" : "1024"}, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Add one doc
SELECT helio_api.insert_one('db','collstats1',' { "a" : 100 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SET client_min_messages TO DEBUG1;
-- coll_stats on collection with single doc
SELECT helio_api.coll_stats('db', 'collstats1');
DEBUG:  [collStats] Small collection. count/avgObjSize are evaluate at runtime.
DEBUG:  executing "SELECT COUNT(*) FROM helio_data.documents_3800" via SPI
DEBUG:  executing "SELECT avg(pg_column_size(document))::int4 FROM helio_data.documents_3800" via SPI
DEBUG:  executing "SELECT array_agg((index_spec).index_name ORDER BY index_id) FROM helio_api_catalog.collection_indexes WHERE collection_id = 3800 AND helio_api_intetnal.index_build_is_in_progress(index_id)" via SPI
DEBUG:  executing "SELECT array_agg((index_spec).index_name ORDER BY index_id) FROM helio_api_catalog.collection_indexes WHERE collection_id = 3800 AND (index_is_valid OR helio_api_intetnal.index_build_is_in_progress(index_id))" via SPI
                                                                                                                                                                                                                               coll_stats                                                                                                                                                                                                                               
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "30"}, "count" : { "$numberLong" : "1"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "73728"}, "nindexes" : { "$numberInt" : "1" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "73728"}, "totalSize" : { "$numberLong" : "147456"}, "indexSizes" : { "_id_" : { "$numberLong" : "73728"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api.coll_stats('db', 'collstats1', 1024);
DEBUG:  [collStats] Small collection. count/avgObjSize are evaluate at runtime.
DEBUG:  executing "SELECT COUNT(*) FROM helio_data.documents_3800" via SPI
DEBUG:  executing "SELECT avg(pg_column_size(document))::int4 FROM helio_data.documents_3800" via SPI
DEBUG:  executing "SELECT array_agg((index_spec).index_name ORDER BY index_id) FROM helio_api_catalog.collection_indexes WHERE collection_id = 3800 AND helio_api_intetnal.index_build_is_in_progress(index_id)" via SPI
DEBUG:  executing "SELECT array_agg((index_spec).index_name ORDER BY index_id) FROM helio_api_catalog.collection_indexes WHERE collection_id = 3800 AND (index_is_valid OR helio_api_intetnal.index_build_is_in_progress(index_id))" via SPI
                                                                                                                                                                                                                          coll_stats                                                                                                                                                                                                                          
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "1"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "72"}, "nindexes" : { "$numberInt" : "1" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "72"}, "totalSize" : { "$numberLong" : "144"}, "indexSizes" : { "_id_" : { "$numberLong" : "72"} }, "scaleFactor" : { "$numberLong" : "1024"}, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Add another doc.
SELECT helio_api.insert_one('db','collstats1',' { "a" : 101 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Count should increase to 2
SELECT helio_api.coll_stats('db', 'collstats1');
DEBUG:  [collStats] Small collection. count/avgObjSize are evaluate at runtime.
DEBUG:  executing "SELECT COUNT(*) FROM helio_data.documents_3800" via SPI
DEBUG:  executing "SELECT avg(pg_column_size(document))::int4 FROM helio_data.documents_3800" via SPI
DEBUG:  executing "SELECT array_agg((index_spec).index_name ORDER BY index_id) FROM helio_api_catalog.collection_indexes WHERE collection_id = 3800 AND helio_api_intetnal.index_build_is_in_progress(index_id)" via SPI
DEBUG:  executing "SELECT array_agg((index_spec).index_name ORDER BY index_id) FROM helio_api_catalog.collection_indexes WHERE collection_id = 3800 AND (index_is_valid OR helio_api_intetnal.index_build_is_in_progress(index_id))" via SPI
                                                                                                                                                                                                                               coll_stats                                                                                                                                                                                                                               
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "60"}, "count" : { "$numberLong" : "2"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "73728"}, "nindexes" : { "$numberInt" : "1" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "73728"}, "totalSize" : { "$numberLong" : "147456"}, "indexSizes" : { "_id_" : { "$numberLong" : "73728"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Insert few more docs ( but keep the total num to < "coll_stats_count_policy_threshold" )
SELECT insert_docs('db', 'collstats1', 17, 0);
 insert_docs 
-------------
 
(1 row)

-- Count should be 19 (1 less than the coll_stats_count_policy_threshold)
SELECT helio_api.coll_stats('db', 'collstats1');
DEBUG:  [collStats] Small collection. count/avgObjSize are evaluate at runtime.
DEBUG:  executing "SELECT COUNT(*) FROM helio_data.documents_3800" via SPI
DEBUG:  executing "SELECT avg(pg_column_size(document))::int4 FROM helio_data.documents_3800" via SPI
DEBUG:  executing "SELECT array_agg((index_spec).index_name ORDER BY index_id) FROM helio_api_catalog.collection_indexes WHERE collection_id = 3800 AND helio_api_intetnal.index_build_is_in_progress(index_id)" via SPI
DEBUG:  executing "SELECT array_agg((index_spec).index_name ORDER BY index_id) FROM helio_api_catalog.collection_indexes WHERE collection_id = 3800 AND (index_is_valid OR helio_api_intetnal.index_build_is_in_progress(index_id))" via SPI
                                                                                                                                                                                                                                coll_stats                                                                                                                                                                                                                                
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "570"}, "count" : { "$numberLong" : "19"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "73728"}, "nindexes" : { "$numberInt" : "1" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "73728"}, "totalSize" : { "$numberLong" : "147456"}, "indexSizes" : { "_id_" : { "$numberLong" : "73728"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SET client_min_messages TO DEFAULT;
-- Create Indexes
CALL helio_api.create_indexes('db', helio_test_helpers.generate_create_index_arg('collstats1', 'index_1', '{"a.$**": 1}'));
                                                                                                                retval                                                                                                                | ok 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } } | t
(1 row)

-- "totalIndexSize" and "storageSize" fields should increase
SELECT helio_api.coll_stats('db', 'collstats1');
                                                                                                                                                                                                                                                     coll_stats                                                                                                                                                                                                                                                     
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "570"}, "count" : { "$numberLong" : "19"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "73728"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "204800"}, "totalSize" : { "$numberLong" : "278528"}, "indexSizes" : { "_id_" : { "$numberLong" : "73728"}, "index_1" : { "$numberLong" : "131072"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Add few more document. So that "coll_stats_count_policy_threshold" is crossed
-- Note: Adding just one extra document (above the threshold limit), may give flaky results 
-- as stats may not be precise enough
SELECT insert_docs('db', 'collstats1', 11, 100);
 insert_docs 
-------------
 
(1 row)

-- The AutoVacuum might still be napping so count in stats might still be 0 (or not updated to reflect latest inserts), 
-- so coll_stats() at this point may/may not switch it's count strategy.
-- In this test we cannot wait till nap time is over, so we manually trigger the ANALYZE
VACUUM ANALYZE helio_data.documents_3800;
-- Since the count from stats should be more than the threshold,
-- coll_stats at this point should return count (and avgObjSize) from stats (which is already updated)
SELECT helio_api.coll_stats('db', 'collstats1');
                                                                                                                                                                                                                                                     coll_stats                                                                                                                                                                                                                                                      
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "900"}, "count" : { "$numberLong" : "30"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "106496"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "204800"}, "totalSize" : { "$numberLong" : "311296"}, "indexSizes" : { "_id_" : { "$numberLong" : "73728"}, "index_1" : { "$numberLong" : "131072"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Insert few more docs.
SELECT insert_docs('db', 'collstats1', 10, 100);
 insert_docs 
-------------
 
(1 row)

-- The AutoVacuum might again be napping, so we manually trigger the ANALYZE
VACUUM ANALYZE helio_data.documents_3800;
-- Count should be 40 (Although its an estimate)
SELECT helio_api.coll_stats('db', 'collstats1');
                                                                                                                                                                                                                                                      coll_stats                                                                                                                                                                                                                                                      
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "1200"}, "count" : { "$numberLong" : "40"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "106496"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "204800"}, "totalSize" : { "$numberLong" : "311296"}, "indexSizes" : { "_id_" : { "$numberLong" : "73728"}, "index_1" : { "$numberLong" : "131072"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SET client_min_messages TO DEFAULT;
-- Delete some documents (so that num of documents is less than threshold)
SELECT helio_api.delete('db', '{"delete":"collstats1", "deletes":[{"q":{"a":{"$gte": 100}},"limit":0}]}');
                                         delete                                          
-----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""23"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

-- In this test we cannot wait till nap time is over, so we manually trigger the ANALYZE
VACUUM ANALYZE helio_data.documents_3800;
-- The coll should now contain 17 docs, so the stats count should also be almost 17, which is less than the threshold
-- so the coll_stats should now return count values by calculating it runtime, and must be precise.
SELECT helio_api.coll_stats('db', 'collstats1');
                                                                                                                                                                                                                                                     coll_stats                                                                                                                                                                                                                                                      
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "510"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "106496"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "204800"}, "totalSize" : { "$numberLong" : "311296"}, "indexSizes" : { "_id_" : { "$numberLong" : "73728"}, "index_1" : { "$numberLong" : "131072"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SET client_min_messages TO DEFAULT;
-- Test with various scale factors
SELECT helio_api.coll_stats('db', 'collstats1', 1);
                                                                                                                                                                                                                                                     coll_stats                                                                                                                                                                                                                                                      
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "510"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "106496"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "204800"}, "totalSize" : { "$numberLong" : "311296"}, "indexSizes" : { "_id_" : { "$numberLong" : "73728"}, "index_1" : { "$numberLong" : "131072"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api.coll_stats('db', 'collstats1', 2);
                                                                                                                                                                                                                                                    coll_stats                                                                                                                                                                                                                                                     
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "255"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "53248"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "102400"}, "totalSize" : { "$numberLong" : "155648"}, "indexSizes" : { "_id_" : { "$numberLong" : "36864"}, "index_1" : { "$numberLong" : "65536"} }, "scaleFactor" : { "$numberLong" : "2"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api.coll_stats('db', 'collstats1', 2.5);
                                                                                                                                                                                                                                                    coll_stats                                                                                                                                                                                                                                                     
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "255"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "53248"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "102400"}, "totalSize" : { "$numberLong" : "155648"}, "indexSizes" : { "_id_" : { "$numberLong" : "36864"}, "index_1" : { "$numberLong" : "65536"} }, "scaleFactor" : { "$numberLong" : "2"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api.coll_stats('db', 'collstats1', 2.99);
                                                                                                                                                                                                                                                    coll_stats                                                                                                                                                                                                                                                     
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "255"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "53248"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "102400"}, "totalSize" : { "$numberLong" : "155648"}, "indexSizes" : { "_id_" : { "$numberLong" : "36864"}, "index_1" : { "$numberLong" : "65536"} }, "scaleFactor" : { "$numberLong" : "2"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api.coll_stats('db', 'collstats1', 100);
                                                                                                                                                                                                                                                coll_stats                                                                                                                                                                                                                                                 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "5"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "1064"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "2048"}, "totalSize" : { "$numberLong" : "3112"}, "indexSizes" : { "_id_" : { "$numberLong" : "737"}, "index_1" : { "$numberLong" : "1310"} }, "scaleFactor" : { "$numberLong" : "100"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api.coll_stats('db', 'collstats1', 1024.99);
                                                                                                                                                                                                                                              coll_stats                                                                                                                                                                                                                                               
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "104"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "200"}, "totalSize" : { "$numberLong" : "304"}, "indexSizes" : { "_id_" : { "$numberLong" : "72"}, "index_1" : { "$numberLong" : "128"} }, "scaleFactor" : { "$numberLong" : "1024"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api.coll_stats('db', 'collstats1', 2147483647);     -- INT_MAX
                                                                                                                                                                                                                                             coll_stats                                                                                                                                                                                                                                             
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "0"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "0"}, "totalSize" : { "$numberLong" : "0"}, "indexSizes" : { "_id_" : { "$numberLong" : "0"}, "index_1" : { "$numberLong" : "0"} }, "scaleFactor" : { "$numberLong" : "2147483647"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api.coll_stats('db', 'collstats1', 2147483647000);  -- More than INT_MAX
                                                                                                                                                                                                                                             coll_stats                                                                                                                                                                                                                                             
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "0"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "0"}, "totalSize" : { "$numberLong" : "0"}, "indexSizes" : { "_id_" : { "$numberLong" : "0"}, "index_1" : { "$numberLong" : "0"} }, "scaleFactor" : { "$numberLong" : "2147483647"}, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Shard the collection
SELECT helio_api.shard_collection('db', 'collstats1', '{"a" : "hashed"}', false);
 shard_collection 
------------------
 
(1 row)

-- Check after sharding
SELECT helio_api.coll_stats('db', 'collstats1');
                                                                                                                                                                                                                                                      coll_stats                                                                                                                                                                                                                                                      
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "510"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "122880"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "385024"}, "totalSize" : { "$numberLong" : "507904"}, "indexSizes" : { "_id_" : { "$numberLong" : "253952"}, "index_1" : { "$numberLong" : "131072"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "collstats1", "pipeline": [ { "$collStats": { "storageStats": { } } } ] }');
                                                                                                                                                                                                                                                  document                                                                                                                                                                                                                                                  
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "storageStats" : { "size" : { "$numberLong" : "510"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "122880"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "385024"}, "totalSize" : { "$numberLong" : "507904"}, "indexSizes" : { "_id_" : { "$numberLong" : "253952"}, "index_1" : { "$numberLong" : "131072"} }, "scaleFactor" : { "$numberLong" : "0"} } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "collstats1", "pipeline": [ { "$collStats": { "storageStats": { }, "count": {} } } ] }');
                                                                                                                                                                                                                                                                   document                                                                                                                                                                                                                                                                    
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "count" : { "$numberLong" : "17"}, "storageStats" : { "size" : { "$numberLong" : "510"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "122880"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "385024"}, "totalSize" : { "$numberLong" : "507904"}, "indexSizes" : { "_id_" : { "$numberLong" : "253952"}, "index_1" : { "$numberLong" : "131072"} }, "scaleFactor" : { "$numberLong" : "0"} } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "collstats1", "pipeline": [ { "$collStats": { "storageStats": { "scale": 10 }, "count": {} } } ] }');
                                                                                                                                                                                                                                                                document                                                                                                                                                                                                                                                                 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "count" : { "$numberLong" : "17"}, "storageStats" : { "size" : { "$numberLong" : "51"}, "count" : { "$numberLong" : "17"}, "avgObjSize" : { "$numberInt" : "30" }, "storageSize" : { "$numberLong" : "12288"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "38502"}, "totalSize" : { "$numberLong" : "50790"}, "indexSizes" : { "_id_" : { "$numberLong" : "25395"}, "index_1" : { "$numberLong" : "13107"} }, "scaleFactor" : { "$numberLong" : "0"} } }
(1 row)

---- Error cases : Scale Factor is < 1
SELECT helio_api.coll_stats('db', 'collstats1', 0);
ERROR:  BSON field 'scale' value must be >= 1, actual value '0'
SELECT helio_api.coll_stats('db', 'collstats1', 0.99);
ERROR:  BSON field 'scale' value must be >= 1, actual value '0'
SELECT helio_api.coll_stats('db', 'collstats1', -0.2);
ERROR:  BSON field 'scale' value must be >= 1, actual value '0'
SELECT helio_api.coll_stats('db', 'collstats1', -2);
ERROR:  BSON field 'scale' value must be >= 1, actual value '-2'
SELECT helio_api.coll_stats('db', 'collstats1', -2147483648);    -- INT_MIN
ERROR:  BSON field 'scale' value must be >= 1, actual value '-2147483648'
SELECT helio_api.coll_stats('db', 'collstats1', -2147483647000); -- Less than INT_MIN
ERROR:  BSON field 'scale' value must be >= 1, actual value '-2147483648'
-- Clean up
SELECT helio_api.drop_collection('db', 'collstats1');
 drop_collection 
-----------------
 t
(1 row)

-- Should return Zero values for non-existing collection
SELECT helio_api.coll_stats('db', 'collstats1');
                                                                                                                                                                       coll_stats                                                                                                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "0"}, "storageSize" : { "$numberLong" : "0"}, "totalSize" : { "$numberLong" : "0"}, "nindexes" : { "$numberInt" : "0" }, "totalIndexSize" : { "$numberLong" : "0"}, "indexSizes" : {  }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

-- create again
SELECT helio_api.create_collection('db', 'collstats1');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

-- empty table with index
CALL helio_api.create_indexes('db', helio_test_helpers.generate_create_index_arg('collstats1', 'index_1', '{"a.$**": 1}'));
                                                                                                                retval                                                                                                                | ok 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } } | t
(1 row)

-- validate both indexes show up.
SELECT helio_api.coll_stats('db', 'collstats1');
                                                                                                                                                                                                                                                   coll_stats                                                                                                                                                                                                                                                   
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "0"}, "avgObjSize" : { "$numberInt" : "0" }, "storageSize" : { "$numberLong" : "65536"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "196608"}, "totalSize" : { "$numberLong" : "262144"}, "indexSizes" : { "_id_" : { "$numberLong" : "65536"}, "index_1" : { "$numberLong" : "131072"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

-- shard
SELECT helio_api.shard_collection('db', 'collstats1', '{"a" : "hashed"}', false);
 shard_collection 
------------------
 
(1 row)

-- validate both indexes show up.
SELECT helio_api.coll_stats('db', 'collstats1');
                                                                                                                                                                                                                                                   coll_stats                                                                                                                                                                                                                                                    
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "0"}, "avgObjSize" : { "$numberInt" : "0" }, "storageSize" : { "$numberLong" : "65536"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "327680"}, "totalSize" : { "$numberLong" : "393216"}, "indexSizes" : { "_id_" : { "$numberLong" : "196608"}, "index_1" : { "$numberLong" : "131072"} }, "scaleFactor" : { "$numberLong" : "1"}, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "collstats1", "pipeline": [ { "$collStats": { "storageStats": { }, "count": {} } } ] }');
                                                                                                                                                                                                                                                                document                                                                                                                                                                                                                                                                 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "count" : { "$numberLong" : "0"}, "storageStats" : { "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "0"}, "avgObjSize" : { "$numberInt" : "0" }, "storageSize" : { "$numberLong" : "65536"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "327680"}, "totalSize" : { "$numberLong" : "393216"}, "indexSizes" : { "_id_" : { "$numberLong" : "196608"}, "index_1" : { "$numberLong" : "131072"} }, "scaleFactor" : { "$numberLong" : "0"} } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "collstats1", "pipeline": [ { "$collStats": { "storageStats": { "scale": 10 }, "count": {} } } ] }');
                                                                                                                                                                                                                                                              document                                                                                                                                                                                                                                                              
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "ns" : "db.collstats1", "count" : { "$numberLong" : "0"}, "storageStats" : { "size" : { "$numberLong" : "0"}, "count" : { "$numberLong" : "0"}, "avgObjSize" : { "$numberInt" : "0" }, "storageSize" : { "$numberLong" : "6553"}, "nindexes" : { "$numberInt" : "2" }, "indexBuilds" : [  ], "totalIndexSize" : { "$numberLong" : "32768"}, "totalSize" : { "$numberLong" : "39321"}, "indexSizes" : { "_id_" : { "$numberLong" : "19660"}, "index_1" : { "$numberLong" : "13107"} }, "scaleFactor" : { "$numberLong" : "0"} } }
(1 row)

-- base case for agg stage
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "collstats1", "pipeline": [ { "$collStats": { } } ] }');
          document          
----------------------------
 { "ns" : "db.collstats1" }
(1 row)

-- invalid cases for $collStats stage
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "nonExistentColl", "pipeline": [ { "$collStats": { } } ] }');
ERROR:  Collection [db.nonExistentColl] not found.
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "collstats1", "pipeline": [ { "$collStats": { "unknownField": { }, "count": {} } } ] }');
ERROR:  BSON field $collStats.unknownField is an unknown field
HINT:  BSON field $collStats.unknownField is an unknown field
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "collstats1", "pipeline": [ { "$collStats": { "storageStats": { "randomField": 1 }, "count": {} } } ] }');
ERROR:  storageStats must be an empty document or have a single numeric field 'scale'
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "collstats1", "pipeline": [ { "$match": { "a": 1 } }, { "$collStats": { "storageStats": { "randomField": 1 }, "count": {} } } ] }');
ERROR:  $collStats is only valid as the first stage in the pipeline.
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "collstats1", "pipeline": [ { "$collStats": { "latencyStats": { }, "count": {} } } ] }');
ERROR:  collStats with latencyStats not supported yet
