SET search_path TO helio_api,helio_core,helio_api_catalog;
SET helio_api.next_collection_id TO 4900;
SET helio_api.next_collection_index_id TO 4900;
SET helio_api.enableGeospatial to on;
SELECT helio_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "agg_geonear", "indexes": [{"key": {"a.b": "2d"}, "name": "my_2d_ab_idx" }, {"key": {"a.b": "2dsphere"}, "name": "my_2ds_ab_idx" }, {"key": {"a.geo": "2dsphere"}, "name": "my_2ds_ageo_idx" }]}');
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "4" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT helio_api.insert_one('db','agg_geonear','{ "_id": 1, "a": { "b": [ 0, 0]} }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','agg_geonear','{ "_id": 2, "a": { "b": [ 1, 1]} }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','agg_geonear','{ "_id": 3, "a": { "b": [ 2, 2]} }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','agg_geonear','{ "_id": 4, "a": { "b": [ 3, 3]} }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','agg_geonear','{ "_id": 5, "a": { "b": [ 4, 4]} }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','agg_geonear','{ "_id": 6, "a": { "b": [ 5, 5]} }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','agg_geonear','{ "_id": 7, "a": { "b": [ 6, 6]} }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','agg_geonear','{ "_id": 8, "a": { "b": [ 7, 7]} }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT helio_api.insert_one('db','agg_geonear','{ "_id": 9, "a": { "b": [ 8, 8]} }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Validations (more validations to follow)
SELECT document FROM helio_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$match": { "query": {  } } }, { "$geoNear": { "near": [5, 6], "key": "a.b", "distanceField": "dist.calculated" } } ]}');
ERROR:  $geoNear was not the first stage in the pipeline.
SELECT document FROM helio_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated" } } ]}');
ERROR:  $geoNear requires a 'key' option as a String
SELECT document FROM helio_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": {  } } ]}');
ERROR:  $geoNear requires a 'distanceField' option as a String
SELECT document FROM helio_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": "value" } ]}');
ERROR:  expected a document to create a bson object
SELECT document FROM helio_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": true, "distanceField": "dist.calculated", "key": "a" } } ]}');
ERROR:  $geoNear requires near argument to be a GeoJSON object or a legacy point(array)
SELECT helio_test_helpers.drop_primary_key('db','agg_geonear');
 drop_primary_key 
------------------
 
(1 row)

SELECT * FROM helio_test_helpers.get_collection_indexes('db', 'agg_geonear') ORDER BY collection_id, index_id;
 collection_id | index_id |                                       index_spec_as_bson                                       | index_is_valid 
---------------+----------+------------------------------------------------------------------------------------------------+----------------
          4900 |     4901 | { "v" : { "$numberInt" : "2" }, "key" : { "a.b" : "2d" }, "name" : "my_2d_ab_idx" }            | t
          4900 |     4902 | { "v" : { "$numberInt" : "2" }, "key" : { "a.b" : "2dsphere" }, "name" : "my_2ds_ab_idx" }     | t
          4900 |     4903 | { "v" : { "$numberInt" : "2" }, "key" : { "a.geo" : "2dsphere" }, "name" : "my_2ds_ageo_idx" } | t
(3 rows)

BEGIN;
SET LOCAL enable_seqscan to off;
SET LOCAL seq_page_cost TO 9999999;
-- Find using $geoNear
SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b" } }, { "$addFields": { "dist.calculated": {"$round":[ "$dist.calculated", 15 ] } } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                               document                                                                               
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] }, "dist" : { "calculated" : { "$numberDouble" : "100000.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ] }, "dist" : { "calculated" : { "$numberDouble" : "100000.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ] }, "dist" : { "calculated" : { "$numberDouble" : "223607.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ] }, "dist" : { "calculated" : { "$numberDouble" : "223607.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ] }, "dist" : { "calculated" : { "$numberDouble" : "360555.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ] }, "dist" : { "calculated" : { "$numberDouble" : "360555.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ] }, "dist" : { "calculated" : { "$numberDouble" : "500000.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ] }, "dist" : { "calculated" : { "$numberDouble" : "640312.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "calculated" : { "$numberDouble" : "781025.0" } } }
(9 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] }, "dist" : { "location" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], "calculated" : { "$numberDouble" : "100000.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ] }, "dist" : { "location" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ], "calculated" : { "$numberDouble" : "100000.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ] }, "dist" : { "location" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ], "calculated" : { "$numberDouble" : "223607.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ] }, "dist" : { "location" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ], "calculated" : { "$numberDouble" : "223607.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ] }, "dist" : { "location" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ], "calculated" : { "$numberDouble" : "360555.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ] }, "dist" : { "location" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ], "calculated" : { "$numberDouble" : "360555.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ] }, "dist" : { "location" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ], "calculated" : { "$numberDouble" : "500000.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ] }, "dist" : { "location" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ], "calculated" : { "$numberDouble" : "640312.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "781025.0" } } }
(9 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                               document                                                                                                               
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ] }, "dist" : { "location" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ], "calculated" : { "$numberDouble" : "1734.0" } } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] }, "dist" : { "location" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], "calculated" : { "$numberDouble" : "1743.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ] }, "dist" : { "location" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ], "calculated" : { "$numberDouble" : "3878.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ] }, "dist" : { "location" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ], "calculated" : { "$numberDouble" : "3895.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ] }, "dist" : { "location" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ], "calculated" : { "$numberDouble" : "6253.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ] }, "dist" : { "location" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ], "calculated" : { "$numberDouble" : "6280.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ] }, "dist" : { "location" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ], "calculated" : { "$numberDouble" : "8709.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ] }, "dist" : { "location" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ], "calculated" : { "$numberDouble" : "11154.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "13606.0" } } }
(9 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location", "distanceMultiplier": 6378.1 } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                document                                                                                                                 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ] }, "dist" : { "location" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ], "calculated" : { "$numberDouble" : "11058593.0" } } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] }, "dist" : { "location" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], "calculated" : { "$numberDouble" : "11119508.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ] }, "dist" : { "location" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ], "calculated" : { "$numberDouble" : "24735922.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ] }, "dist" : { "location" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ], "calculated" : { "$numberDouble" : "24844825.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ] }, "dist" : { "location" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ], "calculated" : { "$numberDouble" : "39883801.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ] }, "dist" : { "location" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ], "calculated" : { "$numberDouble" : "40052537.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ] }, "dist" : { "location" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ], "calculated" : { "$numberDouble" : "55544703.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ] }, "dist" : { "location" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ], "calculated" : { "$numberDouble" : "71138883.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86780976.0" } } }
(9 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": false, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                               document                                                                                                                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] }, "dist" : { "location" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], "calculated" : { "$numberDouble" : "100000.0" } } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ] }, "dist" : { "location" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ], "calculated" : { "$numberDouble" : "100000.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ] }, "dist" : { "location" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ], "calculated" : { "$numberDouble" : "223607.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ] }, "dist" : { "location" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ], "calculated" : { "$numberDouble" : "223607.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ] }, "dist" : { "location" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ], "calculated" : { "$numberDouble" : "360555.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ] }, "dist" : { "location" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ], "calculated" : { "$numberDouble" : "360555.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ] }, "dist" : { "location" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ], "calculated" : { "$numberDouble" : "500000.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ] }, "dist" : { "location" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ], "calculated" : { "$numberDouble" : "640312.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "781025.0" } } }
(9 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": false, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                  document                                                                                                                  
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ] }, "dist" : { "location" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ], "calculated" : { "$numberDouble" : "11058592612.0" } } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] }, "dist" : { "location" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], "calculated" : { "$numberDouble" : "11119507973.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ] }, "dist" : { "location" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ], "calculated" : { "$numberDouble" : "24735921816.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ] }, "dist" : { "location" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ], "calculated" : { "$numberDouble" : "24844824562.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ] }, "dist" : { "location" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ], "calculated" : { "$numberDouble" : "39883800533.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ] }, "dist" : { "location" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ], "calculated" : { "$numberDouble" : "40052537222.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ] }, "dist" : { "location" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ], "calculated" : { "$numberDouble" : "55544702519.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ] }, "dist" : { "location" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ], "calculated" : { "$numberDouble" : "71138883342.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86780975615.0" } } }
(9 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": false, "key": "a.b", "includeLocs": "dist.location", "distanceMultiplier": 0.001 } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                document                                                                                                                 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ] }, "dist" : { "location" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ], "calculated" : { "$numberDouble" : "11058593.0" } } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] }, "dist" : { "location" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], "calculated" : { "$numberDouble" : "11119508.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ] }, "dist" : { "location" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ], "calculated" : { "$numberDouble" : "24735922.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ] }, "dist" : { "location" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ], "calculated" : { "$numberDouble" : "24844825.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ] }, "dist" : { "location" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ], "calculated" : { "$numberDouble" : "39883801.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ] }, "dist" : { "location" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ], "calculated" : { "$numberDouble" : "40052537.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ] }, "dist" : { "location" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ], "calculated" : { "$numberDouble" : "55544703.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ] }, "dist" : { "location" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ], "calculated" : { "$numberDouble" : "71138883.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86780976.0" } } }
(9 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
                                                                                                                  document                                                                                                                  
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ] }, "dist" : { "location" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ], "calculated" : { "$numberDouble" : "11058592612.0" } } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] }, "dist" : { "location" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], "calculated" : { "$numberDouble" : "11119507973.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ] }, "dist" : { "location" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ], "calculated" : { "$numberDouble" : "24735921816.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ] }, "dist" : { "location" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ], "calculated" : { "$numberDouble" : "24844824562.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ] }, "dist" : { "location" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ], "calculated" : { "$numberDouble" : "39883800533.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ] }, "dist" : { "location" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ], "calculated" : { "$numberDouble" : "40052537222.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ] }, "dist" : { "location" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ], "calculated" : { "$numberDouble" : "55544702519.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ] }, "dist" : { "location" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ], "calculated" : { "$numberDouble" : "71138883342.0" } } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "86780975615.0" } } }
(9 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [35, 35] }, "distanceField": "dist.calculated", "key": "a.geo"} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}');
 document 
----------
(0 rows)

--min/max distance test
SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 500000} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 500 kms
                                                                                                                  document                                                                                                                  
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ] }, "dist" : { "location" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ], "calculated" : { "$numberDouble" : "11058592612.0" } } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] }, "dist" : { "location" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], "calculated" : { "$numberDouble" : "11119507973.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ] }, "dist" : { "location" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ], "calculated" : { "$numberDouble" : "24735921816.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ] }, "dist" : { "location" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ], "calculated" : { "$numberDouble" : "24844824562.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ] }, "dist" : { "location" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ], "calculated" : { "$numberDouble" : "39883800533.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ] }, "dist" : { "location" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ], "calculated" : { "$numberDouble" : "40052537222.0" } } }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 2} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 2 cartesian distance
                                                                                                               document                                                                                                                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ] }, "dist" : { "location" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "calculated" : { "$numberDouble" : "0.0" } } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ] }, "dist" : { "location" : [ { "$numberInt" : "1" }, { "$numberInt" : "1" } ], "calculated" : { "$numberDouble" : "141421.0" } } }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 0.1} } , { "$addFields": { "dist.calculated": {"$round":[ { "$multiply": ["$dist.calculated", 100000] }] } } } ]}'); -- Upto 0.1 radians
                                                                                                              document                                                                                                               
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ] }, "dist" : { "location" : [ { "$numberInt" : "6" }, { "$numberInt" : "6" } ], "calculated" : { "$numberDouble" : "1734.0" } } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ] }, "dist" : { "location" : [ { "$numberInt" : "5" }, { "$numberInt" : "5" } ], "calculated" : { "$numberDouble" : "1743.0" } } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "b" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ] }, "dist" : { "location" : [ { "$numberInt" : "7" }, { "$numberInt" : "7" } ], "calculated" : { "$numberDouble" : "3878.0" } } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ] }, "dist" : { "location" : [ { "$numberInt" : "4" }, { "$numberInt" : "4" } ], "calculated" : { "$numberDouble" : "3895.0" } } }
 { "_id" : { "$numberInt" : "9" }, "a" : { "b" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ] }, "dist" : { "location" : [ { "$numberInt" : "8" }, { "$numberInt" : "8" } ], "calculated" : { "$numberDouble" : "6253.0" } } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ] }, "dist" : { "location" : [ { "$numberInt" : "3" }, { "$numberInt" : "3" } ], "calculated" : { "$numberDouble" : "6280.0" } } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ] }, "dist" : { "location" : [ { "$numberInt" : "2" }, { "$numberInt" : "2" } ], "calculated" : { "$numberDouble" : "8709.0" } } }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM helio_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } ]}');
                                                                                                                                                                                                                                                                                        QUERY PLAN                                                                                                                                                                                                                                                                                        
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Subquery Scan on "topQuery_stage_0"
   Output: "topQuery_stage_0".document
   ->  Sort
         Output: (bson_dollar_project_geonear(collection.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::bson)), ((bson_validate_geography(collection.document, 'a.b'::text) <|-|> '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::bson))
         Sort Key: ((bson_validate_geography(collection.document, 'a.b'::text) <|-|> '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::bson))
         ->  Seq Scan on helio_data.documents_4900 collection
               Output: bson_dollar_project_geonear(collection.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::bson), (bson_validate_geography(collection.document, 'a.b'::text) <|-|> '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::bson)
               Filter: (bson_validate_geography(collection.document, 'a.b'::text) IS NOT NULL)
(8 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM helio_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "spherical": true, "key": "a.b", "includeLocs": "dist.location" } } ]}');
                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                  
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Subquery Scan on "topQuery_stage_0"
   Output: "topQuery_stage_0".document
   ->  Sort
         Output: (bson_dollar_project_geonear(collection.document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::bson)), ((bson_validate_geometry(collection.document, 'a.b'::text) <|-|> '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::bson))
         Sort Key: ((bson_validate_geometry(collection.document, 'a.b'::text) <|-|> '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::bson))
         ->  Seq Scan on helio_data.documents_4900 collection
               Output: bson_dollar_project_geonear(collection.document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::bson), (bson_validate_geometry(collection.document, 'a.b'::text) <|-|> '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "spherical" : true, "key" : "a.b", "includeLocs" : "dist.location" }'::bson)
               Filter: (bson_validate_geometry(collection.document, 'a.b'::text) IS NOT NULL)
(8 rows)

EXPLAIN SELECT document FROM helio_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [35, 35] }, "distanceField": "dist.calculated", "key": "a.geo"} } ]}');    
                                                                                                                          QUERY PLAN                                                                                                                           
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Subquery Scan on "topQuery_stage_0"  (cost=10100000001.32..10100000001.37 rows=4 width=32)
   ->  Sort  (cost=10100000001.32..10100000001.33 rows=4 width=40)
         Sort Key: ((bson_validate_geography(collection.document, 'a.geo'::text) <|-|> '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "35" }, { "$numberInt" : "35" } ] }, "distanceField" : "dist.calculated", "key" : "a.geo" }'::bson))
         ->  Seq Scan on documents_4900 collection  (cost=10000000000.00..10100000001.28 rows=4 width=40)
               Filter: (bson_validate_geography(document, 'a.geo'::text) IS NOT NULL)
(5 rows)

-- min / maxDistance Explains
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM helio_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": { "type": "Point", "coordinates": [5, 6] }, "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 500000} } ]}'); -- Upto 500 kms
                                                                                                                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                 
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Subquery Scan on "topQuery_stage_0"
   Output: "topQuery_stage_0".document
   ->  Sort
         Output: (bson_dollar_project_geonear(collection.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::bson)), ((bson_validate_geography(collection.document, 'a.b'::text) <|-|> '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::bson))
         Sort Key: ((bson_validate_geography(collection.document, 'a.b'::text) <|-|> '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::bson))
         ->  Seq Scan on helio_data.documents_4900 collection
               Output: bson_dollar_project_geonear(collection.document, '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::bson), (bson_validate_geography(collection.document, 'a.b'::text) <|-|> '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::bson)
               Filter: ((bson_validate_geography(collection.document, 'a.b'::text) IS NOT NULL) AND ((collection.document <|-|> '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::bson) >= '0'::double precision) AND ((collection.document <|-|> '{ "near" : { "type" : "Point", "coordinates" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ] }, "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "500000" } }'::bson) <= '500000'::double precision))
(8 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM helio_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [0, 0], "distanceField": "dist.calculated", "key": "a.b", "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 2} } ]}'); -- Upto 2 cartesian distance
                                                                                                                                                                                                                                                                                                                                                   QUERY PLAN                                                                                                                                                                                                                                                                                                                                                   
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Subquery Scan on "topQuery_stage_0"
   Output: "topQuery_stage_0".document
   ->  Sort
         Output: (bson_dollar_project_geonear(collection.document, '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::bson)), ((bson_validate_geometry(collection.document, 'a.b'::text) <|-|> '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::bson))
         Sort Key: ((bson_validate_geometry(collection.document, 'a.b'::text) <|-|> '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::bson))
         ->  Seq Scan on helio_data.documents_4900 collection
               Output: bson_dollar_project_geonear(collection.document, '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::bson), (bson_validate_geometry(collection.document, 'a.b'::text) <|-|> '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::bson)
               Filter: ((bson_validate_geometry(collection.document, 'a.b'::text) IS NOT NULL) AND ((collection.document <|-|> '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::bson) >= '0'::double precision) AND ((collection.document <|-|> '{ "near" : [ { "$numberInt" : "0" }, { "$numberInt" : "0" } ], "distanceField" : "dist.calculated", "key" : "a.b", "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberInt" : "2" } }'::bson) <= '2'::double precision))
(8 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM helio_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "agg_geonear", "pipeline": [ { "$geoNear": { "near": [5, 6], "distanceField": "dist.calculated", "key": "a.b", "spherical": true, "includeLocs": "dist.location", "minDistance": 0, "maxDistance": 0.1} } ]}'); -- Upto 0.1 radians
                                                                                                                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                  
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Subquery Scan on "topQuery_stage_0"
   Output: "topQuery_stage_0".document
   ->  Sort
         Output: (bson_dollar_project_geonear(collection.document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::bson)), ((bson_validate_geometry(collection.document, 'a.b'::text) <|-|> '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::bson))
         Sort Key: ((bson_validate_geometry(collection.document, 'a.b'::text) <|-|> '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::bson))
         ->  Seq Scan on helio_data.documents_4900 collection
               Output: bson_dollar_project_geonear(collection.document, '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::bson), (bson_validate_geometry(collection.document, 'a.b'::text) <|-|> '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::bson)
               Filter: ((bson_validate_geometry(collection.document, 'a.b'::text) IS NOT NULL) AND ((collection.document <|-|> '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::bson) >= '0'::double precision) AND ((collection.document <|-|> '{ "near" : [ { "$numberInt" : "5" }, { "$numberInt" : "6" } ], "distanceField" : "dist.calculated", "key" : "a.b", "spherical" : true, "includeLocs" : "dist.location", "minDistance" : { "$numberInt" : "0" }, "maxDistance" : { "$numberDouble" : "0.10000000000000000555" } }'::bson) <= '637810'::double precision))
(8 rows)

ROLLBACK;
RESET helio_api.enableGeospatial;
-- Make sure we fail if the helio_api.enableGeospatial is not set
SELECT helio_api.insert_one('db','not_enabled_test','{ "_id": 1, "a": { "b": [ 0, 0]} }', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM helio_api.collection('db', 'not_enabled_test') WHERE document @@
    '{"a.b": {"$geoWithin": { "$geometry": { "type": "Polygon", "coordinates": [ [ [100, 0], [103, 0], [103, 3], [100, 3], [100, 0] ] ] } } }}';
ERROR:  Geospatial features are not supported yet
