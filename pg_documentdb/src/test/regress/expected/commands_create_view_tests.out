SET search_path TO helio_api,helio_core,helio_api_internal;
SET helio_api.next_collection_id TO 6500;
SET helio_api.next_collection_index_id TO 6500;
-- first create a collection (invalid)
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests", "capped": true }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests", "capped": 1}');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests", "capped": 2.3}');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests", "capped": "true"}');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests", "capped": "false"}');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests", "timeseries": { "timeField": "a" } }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests", "clusteredIndex": { } }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": 2 }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": 2...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": false }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": f...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": null }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": n...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": {"$undefined": true} }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": {...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "" }');   -- empty string not allowed
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
-- create valid collections
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_not_capped1", "capped": false}');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_not_capped2", "capped": 0}');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_emoji_ðŸ‘½" }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests" }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
-- noops
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests" }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
-- Views error out if the viewOn is not a string, or empty string
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_view", "viewOn": 2 }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_view", "viewOn": false }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_view", "viewOn": "" }');   -- empty string not allowed
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
-- viewOn can be null or undefined. It is treated as if it was not specified
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_view_n",  "viewOn": null }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_view_np", "viewOn": null, "pipeline": [] }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_view_u",  "viewOn": {"$undefined": true} }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_view_up", "viewOn": {"$undefined": true}, "pipeline": [] }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
-- create a view against it (no pipeline): succeeds
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_view_1", "viewOn": "create_view_tests" }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_view_emoji_ðŸ‘º", "viewOn": "create_view_tests_emoji_ðŸ‘½" }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
-- chain the view
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_view_2", "viewOn": "create_view_tests_view_1", "pipeline": [ { "$match": { "a": { "$gt": 5 } } } ] }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
-- chain one more view
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests_view_3", "viewOn": "create_view_tests_view_2", "pipeline": [ { "$sort": { "a": 1 } } ] }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
-- query all 4
SELECT document FROM helio_api_catalog.bson_aggregation_find('db', '{ "find": "create_view_tests_view_3" }');
ERROR:  schema "helio_api_catalog" does not exist
LINE 1: SELECT document FROM helio_api_catalog.bson_aggregation_find...
                             ^
SELECT document FROM helio_api_catalog.bson_aggregation_find('db', '{ "find": "create_view_tests_view_2" }');
ERROR:  schema "helio_api_catalog" does not exist
LINE 1: SELECT document FROM helio_api_catalog.bson_aggregation_find...
                             ^
SELECT document FROM helio_api_catalog.bson_aggregation_find('db', '{ "find": "create_view_tests_view_1" }');
ERROR:  schema "helio_api_catalog" does not exist
LINE 1: SELECT document FROM helio_api_catalog.bson_aggregation_find...
                             ^
SELECT document FROM helio_api_catalog.bson_aggregation_find('db', '{ "find": "create_view_tests" }');
ERROR:  schema "helio_api_catalog" does not exist
LINE 1: SELECT document FROM helio_api_catalog.bson_aggregation_find...
                             ^
-- now insert 3 docs in the table 
SELECT helio_api.insert_one('db', 'create_view_tests', '{ "_id": 1, "a": 4 }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.insert_one('db', 'create_view_tests', '{ "_...
               ^
SELECT helio_api.insert_one('db', 'create_view_tests', '{ "_id": 2, "a": 1 }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.insert_one('db', 'create_view_tests', '{ "_...
               ^
SELECT helio_api.insert_one('db', 'create_view_tests', '{ "_id": 3, "a": 140 }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.insert_one('db', 'create_view_tests', '{ "_...
               ^
SELECT helio_api.insert_one('db', 'create_view_tests', '{ "_id": 4, "a": 40 }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.insert_one('db', 'create_view_tests', '{ "_...
               ^
SELECT document FROM helio_api_catalog.bson_aggregation_find('db', '{ "find": "create_view_tests_view_3" }');
ERROR:  schema "helio_api_catalog" does not exist
LINE 1: SELECT document FROM helio_api_catalog.bson_aggregation_find...
                             ^
SELECT document FROM helio_api_catalog.bson_aggregation_find('db', '{ "find": "create_view_tests_view_2" }');
ERROR:  schema "helio_api_catalog" does not exist
LINE 1: SELECT document FROM helio_api_catalog.bson_aggregation_find...
                             ^
SELECT document FROM helio_api_catalog.bson_aggregation_find('db', '{ "find": "create_view_tests_view_1" }');
ERROR:  schema "helio_api_catalog" does not exist
LINE 1: SELECT document FROM helio_api_catalog.bson_aggregation_find...
                             ^
SELECT document FROM helio_api_catalog.bson_aggregation_find('db', '{ "find": "create_view_tests" }');
ERROR:  schema "helio_api_catalog" does not exist
LINE 1: SELECT document FROM helio_api_catalog.bson_aggregation_find...
                             ^
-- create views with different options
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests", "viewOn": "create_view_tests_view_5", "pipeline": [ { "$sort": { "a": 1 } } ] }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
-- Can't write to views
SELECT helio_api.insert_one('db', 'create_view_tests_view_1', '{ "_id": 5, "a": 60 }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.insert_one('db', 'create_view_tests_view_1'...
               ^
SELECT helio_api.update('db', '{ "update": "create_view_tests_view_1", "updates": [ { "q": {}, "u": {} } ] }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.update('db', '{ "update": "create_view_test...
               ^
SELECT helio_api.delete('db', '{ "delete": "create_view_tests_view_1", "deletes": [ { "q": {}, "limit": 1 } ] }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.delete('db', '{ "delete": "create_view_test...
               ^
SELECT helio_api.shard_collection('db', 'create_view_tests_view_1', '{ "_id": "hashed" }', false);
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.shard_collection('db', 'create_view_tests_v...
               ^
SELECT helio_api.shard_collection('db', 'create_view_tests_view_1', '{ "_id": "hashed" }', true);
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.shard_collection('db', 'create_view_tests_v...
               ^
-- can drop/rename a view
SELECT helio_api.rename_collection('db', 'create_view_tests_view_1', 'create_view_tests_view_4');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.rename_collection('db', 'create_view_tests_...
               ^
SELECT document FROM helio_api_catalog.bson_aggregation_find('db', '{ "find": "create_view_tests_view_1" }');
ERROR:  schema "helio_api_catalog" does not exist
LINE 1: SELECT document FROM helio_api_catalog.bson_aggregation_find...
                             ^
SELECT helio_api.drop_collection('db', 'create_view_tests_view_3');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.drop_collection('db', 'create_view_tests_vi...
               ^
-- drop the collection (view still works)
SELECT helio_api.drop_collection('db', 'create_view_tests');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.drop_collection('db', 'create_view_tests');
               ^
SELECT document FROM helio_api_catalog.bson_aggregation_find('db', '{ "find": "create_view_tests_view_1" }');
ERROR:  schema "helio_api_catalog" does not exist
LINE 1: SELECT document FROM helio_api_catalog.bson_aggregation_find...
                             ^
-- create a view cycle (fails)
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_tests", "viewOn": "create_view_tests_view_1" }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
-- recreate a collection
SELECT helio_api.insert_one('db', 'create_view_tests', '{ "_id": 3, "a": 140 }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.insert_one('db', 'create_view_tests', '{ "_...
               ^
-- view works again
SELECT document FROM helio_api_catalog.bson_aggregation_find('db', '{ "find": "create_view_tests_view_1" }');
ERROR:  schema "helio_api_catalog" does not exist
LINE 1: SELECT document FROM helio_api_catalog.bson_aggregation_find...
                             ^
-- do a coll_mod
SELECT database_name, collection_name, view_definition FROM helio_api_catalog.collections WHERE collection_name = 'create_view_tests_view_1';
ERROR:  relation "helio_api_catalog.collections" does not exist
LINE 1: ...abase_name, collection_name, view_definition FROM helio_api_...
                                                             ^
SELECT helio_api.coll_mod('db', 'create_view_tests_view_1', '{ "collMod": "create_view_tests_view_1", "viewOn": "create_view_tests_view_4", "pipeline": [] }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.coll_mod('db', 'create_view_tests_view_1', ...
               ^
SELECT database_name, collection_name, view_definition FROM helio_api_catalog.collections WHERE collection_name = 'create_view_tests_view_1';
ERROR:  relation "helio_api_catalog.collections" does not exist
LINE 1: ...abase_name, collection_name, view_definition FROM helio_api_...
                                                             ^
-- create a much longer cycle
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_cycle_1", "viewOn": "create_view_cycle_2" }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_cycle_2", "viewOn": "create_view_cycle_3" }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_cycle_3", "viewOn": "create_view_cycle_4" }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
SELECT helio_api.create_collection_view('db', '{ "create": "create_view_cycle_4", "viewOn": "create_view_cycle_1" }');
ERROR:  schema "helio_api" does not exist
LINE 1: SELECT helio_api.create_collection_view('db', '{ "create": "...
               ^
-- create with long name
SELECT helio_api.create_collection_view('db', FORMAT('{ "create": "create_view_cycle_4_%s", "viewOn": "create_view_cycle_1" }', repeat('1bc', 80))::helio_core.bson);
ERROR:  schema "helio_core" does not exist
LINE 1: ...n": "create_view_cycle_1" }', repeat('1bc', 80))::helio_core...
                                                             ^
